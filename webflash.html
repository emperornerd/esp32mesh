<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Protest Node Flash Tool</title>
  <link rel="icon" href="ico.png" type="image/png">
  <style>
    :root {
      --primary-color: #0066cc;
      --primary-hover: #0052a3;
      --secondary-color: #c60;
      --secondary-hover: #a50;
      --dark-bg: #222;
      --medium-bg: #333;
      --light-text: #eee;
      --medium-text: #aaa;
      --dark-text: #111;
      --border-color: #444;
      --success-color: #0f0;
      --error-color: #f55;
    }
    * { box-sizing: border-box; }
    body {
      background: var(--dark-bg);
      color: var(--light-text);
      font-family: Arial, sans-serif;
      margin: 0;
      padding: 0;
      height: 100vh;
      overflow: hidden;
      display: flex;
    }
    .main-content {
      flex: 1;
      padding: 20px;
      overflow-y: scroll;
      height: 100vh;
      transition: margin-left 0.3s ease;
    }
    .main-content.console-open {
      margin-left: 450px;
    }
    .container {
      max-width: 900px;
      margin: 0 auto;
      padding-bottom: 40px;
    }
    h1 {
      text-align: center;
      margin: 20px 0 30px 0;
      font-size: 32px;
    }
    .info-box {
      background: var(--medium-bg);
      border-radius: 8px;
      padding: 20px;
      margin-bottom: 20px;
      border: 1px solid var(--border-color);
    }
    .info-row {
      display: flex;
      justify-content: space-between;
      margin: 8px 0;
      font-size: 14px;
    }
    .info-label { color: var(--medium-text); }
    .info-value { font-weight: bold; }
    .status-good { color: var(--success-color); }
    .status-bad { color: var(--error-color); }
    
    .button-container {
      text-align: center;
      margin: 30px 0;
    }
    
    .flash-mode-section {
      background: var(--medium-bg);
      border: 1px solid var(--border-color);
      border-radius: 8px;
      padding: 20px;
      margin: 20px 0;
      text-align: center;
    }
    .flash-mode-section label {
      margin: 0 15px;
      font-size: 14px;
      cursor: pointer;
    }
    .flash-mode-section input {
      margin-right: 8px;
      vertical-align: middle;
    }

    /* Base styles for all primary action buttons */
    .btn {
      color: #fff;
      border: none;
      padding: 15px 40px;
      font-size: 18px;
      font-weight: bold;
      border-radius: 8px;
      cursor: pointer;
      transition: background-color 0.2s, transform 0.1s;
    }
    .btn:hover {
      transform: translateY(-2px);
    }
    .btn:active {
      transform: translateY(0px);
    }
    .btn:disabled {
      background-color: #555 !important;
      cursor: not-allowed;
      transform: none;
    }

    /* Flasher Button */
    #flashBtn {
      background: var(--primary-color);
    }
    #flashBtn:hover:not(:disabled) {
      background: var(--primary-hover);
    }
    
    /* Secondary buttons, e.g., download */
    .btn-secondary {
      background: var(--secondary-color);
      color: var(--dark-text); /* Ensure dark text for contrast on lighter secondary color */
      padding: 12px 24px;
      font-size: 16px;
    }
    .btn-secondary:hover:not(:disabled) {
      background: var(--secondary-hover);
    }
    
    /* NEW: Style for Modal Cancel Button (Neutral/Dark) */
    .btn-neutral {
        background: #444;
        color: var(--light-text); 
    }
    .btn-neutral:hover:not(:disabled) {
        background: #555;
    }
    
    .warning {
      background: #553300;
      color: #ff9;
      border-left: 4px solid #fb923c;
      padding: 15px 20px;
      border-radius: 6px;
      margin: 20px 0;
      font-size: 14px;
    }
    
    .boot-prompt {
      background: #004488;
      color: #fff;
      border-left: 4px solid #0088ff;
      padding: 15px 20px;
      border-radius: 6px;
      margin: 20px 0;
      font-size: 14px;
      display: none;
    }
    .boot-prompt.show { display: block; }
    
    .instructions {
      background: var(--medium-bg);
      border-radius: 8px;
      padding: 20px;
      margin-top: 30px;
      font-size: 14px;
      line-height: 1.6;
      border: 1px solid var(--border-color);
    }

    .mode-explainer {
      background: linear-gradient(135deg, rgba(0, 102, 204, 0.1), rgba(204, 102, 0, 0.1));
      border: 1px solid var(--border-color);
      border-radius: 8px;
      padding: 18px 20px;
      margin: 20px 0;
      font-size: 13px;
      line-height: 1.5;
    }
    
    .mode-explainer h4 {
      margin: 0 0 12px 0;
      font-size: 15px;
      color: var(--light-text);
      display: flex;
      align-items: center;
      gap: 8px;
    }
    
    .mode-grid {
      display: grid;
      grid-template-columns: 1fr 1fr;
      gap: 15px;
      margin-top: 12px;
    }
    
    .mode-card {
      background: rgba(0, 0, 0, 0.3);
      border: 1px solid var(--border-color);
      border-radius: 6px;
      padding: 12px;
    }
    
    .mode-card h5 {
      margin: 0 0 8px 0;
      font-size: 14px;
      color: #8ab4f8;
    }
    
    .mode-card p {
      margin: 0;
      color: var(--medium-text);
      font-size: 12px;
      line-height: 1.4;
    }

    .psk-display-wrapper {
        display: flex;
        justify-content: center;
        align-items: center;
        margin-top: 20px;
        gap: 10px;
    }
    
    #sessionPskDisplay {
        font-family: 'Consolas', monospace;
        font-size: 14px;
        background: var(--dark-text);
        padding: 10px;
        border-radius: 4px;
        border: 1px solid var(--border-color);
        color: var(--light-text);
        flex-grow: 1;
        max-width: 400px;
        text-align: left;
    }

    /* NEW STYLES for subtle refresh button */
    #clearPskBtn {
        background: var(--medium-bg);
        color: var(--secondary-color);
        border: 1px solid var(--border-color);
        width: 40px;
        height: 40px;
        padding: 0;
        border-radius: 50%;
        font-size: 20px;
        line-height: 1;
        display: flex;
        justify-content: center;
        align-items: center;
        transition: background-color 0.2s, color 0.2s;
        flex-shrink: 0;
    }
    #clearPskBtn:hover {
        background: var(--secondary-color);
        color: var(--light-text);
        transform: rotate(-30deg);
        transform-origin: center;
    }

    /* NEW: Styles for Advanced Section */
    .advanced-section {
        background: var(--medium-bg);
        border: 1px solid var(--border-color);
        border-radius: 8px;
        margin-top: 20px;
    }
    .advanced-section summary {
        /* CRITICAL FIX: Ensure clickability by aggressively promoting to top layer */
        position: relative;
        z-index: 9999; 
        font-size: 16px;
        font-weight: bold;
        padding: 15px 20px;
        cursor: pointer;
        outline: none;
    }
    .advanced-section summary::-webkit-details-marker {
        color: var(--secondary-color);
    }
    .advanced-content {
        padding: 0 20px 20px 20px;
        border-top: 1px solid var(--border-color);
        text-align: center;
    }
    .advanced-content p {
        font-size: 13px;
        color: var(--medium-text);
        margin-bottom: 15px;
    }
    .advanced-content input[type="file"] {
        margin: 10px auto;
        display: block;
    }
    .btn-advanced {
        background: #444;
        margin-top: 10px;
    }
    .btn-advanced:hover:not(:disabled) {
        background: #555;
    }
    
    /* MODIFIED: Style for the header link (Top Right) */
    .header-link {
        position: absolute;
        top: 20px;
        right: 20px; /* MODIFIED from left: 20px */
        color: var(--medium-text); /* #aaa */
        text-decoration: none;
        font-size: 14px;
        transition: color 0.2s;
    }
    .header-link:hover {
        color: var(--light-text); /* #eee */
    }
    .header-link span {
        margin-left: 5px; /* MODIFIED from margin-right: 5px */
    }

    /* NEW: Styles for Disabled Secure Mode Message */
    #secure-mode-disabled-message {
        background: var(--medium-bg); /* Changed from #444 to match other sections */
        border: 1px solid var(--border-color); /* Changed from #777 */
        color: var(--light-text);
        padding: 20px;
        border-radius: 8px;
        margin: 20px 0;
        text-align: left;
    }
    #secure-mode-disabled-message h4 {
        color: #ff9;
        margin-top: 0;
    }
    #secure-mode-disabled-message a {
        color: #8ab4f8;
        text-decoration: none;
    }
    #secure-mode-disabled-message a:hover {
        text-decoration: underline;
    }
    
    /* Center the override button */
    #secure-mode-disabled-message button {
        display: block;
        margin: 15px auto 0 auto;
        width: auto;
    }

    /* Modal for override prompt */
    .modal-overlay {
      position: fixed;
      inset: 0;
      background: rgba(0,0,0,0.6);
      display: none;
      align-items: center;
      justify-content: center;
      z-index: 2000;
    }
    .modal-overlay.show { display: flex; }
    .modal {
      background: #1f1f1f;
      border: 1px solid var(--border-color);
      border-radius: 8px;
      padding: 20px;
      width: 90%;
      max-width: 520px;
      color: var(--light-text);
    }
    .modal h3 { margin-top: 0; }
    .modal p { color: var(--medium-text); }
    .modal .actions { margin-top: 16px; display:flex; gap: 10px; justify-content: flex-end; }
    .modal .actions button { min-width: 140px; }

    @media (max-width: 768px) {
      .mode-grid {
        grid-template-columns: 1fr;
      }
      /* MODIFIED: Move link to top right on mobile */
      .header-link {
        top: 10px;
        right: 10px; /* MODIFIED from left: 10px */
      }
    }
    
    /* Console Panel - Left Side */
    .log-container {
      position: fixed; top: 0; left: 0; bottom: 0;
      width: 450px;
      background: #1a1a1a;
      border-right: 2px solid var(--border-color);
      display: flex; flex-direction: column;
      transition: transform 0.3s ease;
      z-index: 1000;
    }
    .log-container.minimized {
      transform: translateX(calc(-100% + 50px));
    }
    .log-container.minimized .resize-handle { display: none; }
    .log-container.minimized .log-header {
      position: absolute;
      right: 0;
      top: 0;
      cursor: pointer;
      writing-mode: vertical-rl;
      text-orientation: mixed;
      width: 50px;
      padding: 15px 10px;
      border-bottom: none;
    }
    .log-container.minimized .log-header:hover { background: var(--primary-color); }
    .log-container.minimized .log-header h3 { transform: rotate(180deg); }
    .log-container.minimized .log-content { display: none; }
    
    .resize-handle {
      position: absolute; right: 0; top: 0; bottom: 0;
      width: 6px; cursor: ew-resize; z-index: 10;
      left: auto;
    }
    
    .log-header {
      display: flex; justify-content: space-between; align-items: center;
      padding: 15px 20px; background: #2a2a2a;
      user-select: none; flex-shrink: 0;
      border-bottom: 1px solid var(--border-color); cursor: pointer;
    }
    .log-header h3 { margin: 0; font-size: 16px; }
    .log-content { flex: 1; padding: 15px; overflow-y: auto; overflow-x: hidden; }
    pre {
      background: #000; color: var(--success-color);
      font-family: 'Consolas', 'Monaco', monospace; white-space: pre-wrap;
      word-wrap: break-word; border: 1px solid var(--border-color);
      border-radius: 6px; padding: 12px; margin: 0;
      font-size: 12px; line-height: 1.5;
    }
    
    @media (max-width: 1024px) {
      body { flex-direction: column; }
      .main-content { height: auto; min-height: calc(100vh - 300px); margin-left: 0 !important; }
      .main-content.console-open { margin-bottom: 300px; }
      .log-container {
        position: fixed; top: auto; right: 0; bottom: 0; left: 0;
        width: auto !important; height: 300px;
        border-right: none; border-top: 2px solid var(--border-color);
      }
      .log-container.minimized { transform: translateY(calc(100% - 50px)); }
      .log-container.minimized .log-header {
          position: static; /* Revert for bottom bar layout */
          writing-mode: horizontal-tb;
          width: auto;
          padding: 12px 20px;
      }
      .log-container.minimized .log-header h3 { transform: none; }
      .resize-handle {
        left: 0; right: 0; top: 0; bottom: auto;
        width: auto; height: 6px; cursor: ns-resize;
      }
    }
  </style>
  
  <script type="module" src="https://unpkg.com/esp-web-tools@10/dist/web/install-button.js?module"></script>
</head>
<body>
  <div class="main-content" id="mainContent">
    <div class="container">
      <a href="index.html" class="header-link">
        Back to Project Home <span>&larr;</span>
      </a>
      <h1>Protest Node Flash Tool</h1>
      
      <div class="warning">
        <strong>‚ö†Ô∏è Before flashing:</strong>
        <ul>
          <li>Close any serial monitor programs (Arduino IDE, PuTTY, etc.)</li>
          <li>Close any other browser tabs using the ESP32</li>
          <li>Unplug and replug your ESP32 if needed</li>
		  <li>If you have trouble connecting to the next device after a flash (if applicable) refresh the web page. If in secure mode, your session will be retained.</li>
        </ul>
      </div>

      <div class="mode-explainer">
        <h4>üîê Understanding Flash Modes</h4>
        <div class="mode-grid">
          <div class="mode-card">
            <h5>Compatibility Mode</h5>
            <p>Uses the default symmetric key included in the public code. Suitable for testing but not secure for production deployment. All devices share the same PSK (encryption password, essentially). This means an adversary can extract the key from your source or firmware and inject or intercept traffic. This may be acceptable for testing or smaller events less likely to be directly targeted. The benefit is it‚Äôs easy to expand and use (you won‚Äôt have to reflash all your devices when you add more nodes or figure out how to use a BIN file).</p>
          </div>
          <div class="mode-card">
            <h5>Secure Mode</h5>
            <p>Generates a unique session PSK and patches the firmware before flashing. Each session uses a different key, replacing the public default PSK (encryption password, essentially) for enhanced security. All nodes must be flashed to that key, so either flash them all in one website session, or download the firmware (bin) and load it with Arduino IDE (for example). These nodes will not be able to communicate with nodes using the default key in compatibility mode. The nodes will have to all be reflashed upon getting new nodes OR you have to download and use the BIN instead of using the web flasher. If you fail to download the BIN on the first flash, all devices will have to be reflashed.</p>
          </div>
        </div>
      </div>

      <div class="boot-prompt" id="bootPrompt">
        <strong>üîÑ Press BOOT button on your ESP32</strong>
        <p>If flashing fails or times out, you may need to manually enter boot mode.</p>
      </div>

      <div class="flash-mode-section">
        <label><input type="radio" name="flashMode" value="compatibility" id="radioCompatibility"> Compatibility Mode</label>
        <label><input type="radio" name="flashMode" value="secure" id="radioSecure"> Secure Mode</label>
      </div>
      
      <div class="button-container" id="buttonContainer">
      </div>
      <div id="compatibility-mode-controls" style="text-align: center; margin: 20px 0;">
         <a href="./sketch_jun11a.ino.merged.bin" download="unmodified_firmware.bin" style="text-decoration: none;">
            <button class="btn btn-secondary">Download Unmodified Firmware</button>
         </a>
         <p style="font-size: 12px; color: var(--error-color); margin-top: 10px; max-width: 450px; margin-left: auto; margin-right: auto;">
            <strong>Warning:</strong> This firmware is unmodified and uses a default, insecure key. It should only be used for testing purposes or situations where the threat is lower (smaller protests or other contexts where a compromise has less significant consequences).
         </p>
      </div>
      
      <div id="secure-mode-disabled-message" style="display: none;">
          <h4>Secure Mode: Feature in Development</h4>
          <p>The functionality to generate a unique session key and flash patched firmware directly from the web tool is currently under development.</p>
          <p>For enhanced security, we recommend you change the Pre-Shared Key (PSK) manually in the source code and flash your devices using the Arduino IDE.</p>
          <p><a href="https://github.com/emperornerd/esp32mesh" target="_blank">github.com/emperornerd/esp32mesh</a></p>
          <button id="overrideSecureBtn" class="btn btn-secondary" style="margin-top: 15px;">
            Loading Toggle State...
          </button>
      </div>

      <div id="secure-mode-controls" style="display: none; text-align: center; margin: 20px 0;">
        
        <button id="downloadSecureBtn" class="btn btn-secondary" disabled>
          Download Patched Secure Firmware
        </button>
        
        <div class="psk-display-wrapper">
            <div id="sessionPskDisplay">
              Session PSK will be generated automatically...
            </div>
             <button id="clearPskBtn" title="Start New Secure Session (Clear Key)">
                &#x21BB; </button>
        </div>
      </div>

      <details class="advanced-section">
        <summary>Advanced Options</summary>
        <div class="advanced-content">
            <h4>Flash from File</h4>
            <p>
                This allows you to flash a pre-compiled `.bin` file from your computer. This is useful for flashing a previously downloaded "Secure Mode" binary to new devices to ensure they all share the same key. This will ignore the mode selection above.
            </p>
            <input type="file" id="firmwareUpload" accept=".bin">
            <button id="flashUploadedBtn" class="btn btn-advanced" disabled>Flash Uploaded BIN</button>
        </div>
      </details>
      <div class="instructions">
        <h3>üìã Instructions</h3>
        <ol>
          <li>Connect your ESP32 to your computer via USB.</li>
          <li>Select your flashing mode. For Secure Mode, a key is generated for your session automatically.</li>
          <li>Click **"Flash Firmware"** and select the ESP32 port from the popup.</li>
          <li>Wait for flashing to complete. </li>
          <li>Press RESET on your ESP32 after the flash is complete. </li>
		  <li>If you have trouble connecting to the next device (if applicable) refresh the web page. If in secure mode, your session will be retained.</li>
        </ol>
      </div>

      <div class="info-box">
        <div class="info-row"><span class="info-label">User Agent:</span><span class="info-value" id="browser"></span></div>
        <div class="info-row"><span class="info-label">Platform:</span><span class="info-value" id="platform"></span></div>
        <div class="info-row"><span class="info-label">Secure Context:</span><span class="info-value" id="secure"></span></div>
        <div class="info-row"><span class="info-label">Web Serial API:</span><span class="info-value" id="serial"></span></div>
      </div>
    </div>
  </div>

  <div class="log-container" id="logContainer">
    <div class="resize-handle" id="resizeHandle"></div>
    <div class="log-header" id="logHeader"><h3>üìä Console Output</h3></div>
    <div class="log-content"><pre id="log">Ready to flash...</pre></div>
  </div>

  <div class="modal-overlay" id="secureOverrideModal" aria-hidden="true">
    <div class="modal" role="dialog" aria-modal="true" aria-labelledby="secureOverrideTitle">
      <h3 id="secureOverrideTitle">Enable Secure Mode?</h3>
      <p>You attempted to select Secure Mode, but Secure Mode is currently disabled. How would you like to proceed?</p>
      <ul style="color:var(--medium-text)">
        <li><strong>Enable for this session:</strong> Immediately enable Secure Mode for this tab only (temporary). This is a development and test feature. Currently the only SECURE way to flash this is manually changing the PSK in code.</li>
        <li><strong>Cancel:</strong> Stay in Compatibility Mode.</li>
      </ul>
      <div class="actions">
        <button id="cancelOverrideBtn" class="btn btn-neutral">Cancel</button>
        <button id="enableSessionBtn" class="btn btn-secondary">Enable for this session</button>
      </div>
    </div>
  </div>

  <script>
    // ---------------------------------------------
    // SECURE MODE DISABLE FLAG: Set to 'false' to re-enable Secure Mode functionality for dev/test.
    const DISABLE_SECURE_MODE = false;
    // ---------------------------------------------

    const browserEl = document.getElementById('browser');
    const platformEl = document.getElementById('platform');
    const serialEl = document.getElementById('serial');
    const secureEl = document.getElementById('secure');
    const logEl = document.getElementById('log');
    const bootPrompt = document.getElementById('bootPrompt');
    const logContainer = document.getElementById('logContainer');
    const resizeHandle = document.getElementById('resizeHandle');
    const logHeader = document.getElementById('logHeader');
    const mainContent = document.getElementById('mainContent');
    const buttonContainer = document.getElementById('buttonContainer');
    
    // UI ELEMENTS
    const secureModeControls = document.getElementById('secure-mode-controls');
    const compatibilityModeControls = document.getElementById('compatibility-mode-controls');
    const sessionPskDisplay = document.getElementById('sessionPskDisplay');
    const downloadSecureBtn = document.getElementById('downloadSecureBtn');
    const clearPskBtn = document.getElementById('clearPskBtn');
    const radioCompatibility = document.getElementById('radioCompatibility');
    const radioSecure = document.getElementById('radioSecure');
    const secureModeDisabledMessage = document.getElementById('secure-mode-disabled-message'); 
    const overrideSecureBtn = document.getElementById('overrideSecureBtn'); 

    // Modal elements
    const secureOverrideModal = document.getElementById('secureOverrideModal');
    const enableSessionBtn = document.getElementById('enableSessionBtn');
    // Removed: const enablePermanentBtn = document.getElementById('enablePermanentBtn');
    const cancelOverrideBtn = document.getElementById('cancelOverrideBtn');

    // NEW: ADVANCED UI ELEMENTS
    const firmwareUpload = document.getElementById('firmwareUpload');
    const flashUploadedBtn = document.getElementById('flashUploadedBtn');

    // Use 'let' for the install button so it can be reassigned during a reset
    let installButton;

    // SESSION/PERSISTENT VARIABLES
    let patchedFirmwareUrl = null;
    let uploadedFileUrl = null; 
    let sessionPsk = sessionStorage.getItem('sessionPsk');

    // Determine secure mode enabled state:
    // - permanent flag in localStorage OR
    // - temporary flag in sessionStorage (set when user chooses session-only override)
    let isSecureModeEnabled = (localStorage.getItem('isSecureModeEnabled') === 'true') ||
                              (sessionStorage.getItem('isSecureModeTemp') === 'true');

    let isResetting = false;

    // Display system info
    browserEl.textContent = navigator.userAgent;
    platformEl.textContent = navigator.platform;
    const hasSerial = 'serial' in navigator;
    serialEl.textContent = hasSerial ? '‚úÖ Available' : '‚ùå Not Available';
    serialEl.className = hasSerial ? 'info-value status-good' : 'info-value status-bad';
    const isSecure = window.isSecureContext;
    secureEl.textContent = isSecure ? '‚úÖ Yes' : '‚ùå No';
    secureEl.className = isSecure ? 'info-value status-good' : 'info-value status-bad';

    function log(msg, type = 'info') {
      const time = new Date().toLocaleTimeString();
      const prefix = type === 'error' ? '‚ùå' : type === 'success' ? '‚úÖ' : '‚ÑπÔ∏è';
      logEl.textContent += `[${time}] ${prefix} ${msg}\n`;
      logEl.scrollTop = logEl.scrollHeight;
      console[type === 'error' ? 'error' : 'log'](msg);
    }

    logHeader.addEventListener('click', () => {
        logContainer.classList.toggle('minimized');
        mainContent.classList.toggle('console-open', !logContainer.classList.contains('minimized'));
    });
    mainContent.classList.add('console-open'); // Start with console open

    // Resizable console logic
    let isResizing = false;
    let startX, startY, startWidth, startHeight;
    resizeHandle.addEventListener('mousedown', (e) => { isResizing = true; startX = e.clientX; startY = e.clientY; startWidth = logContainer.offsetWidth; startHeight = logContainer.offsetHeight; e.preventDefault(); });
    document.addEventListener('mousemove', (e) => {
      if (!isResizing) return;
      if (window.innerWidth > 1024) { const width = startWidth + (e.clientX - startX); if (width >= 300 && width <= window.innerWidth * 0.6) { logContainer.style.width = width + 'px'; mainContent.style.marginLeft = width + 'px'; } }
      else { const height = startHeight - (e.clientY - startY); if (height >= 150 && height <= window.innerHeight * 0.7) { logContainer.style.height = height + 'px'; } }
    });
    document.addEventListener('mouseup', () => { isResizing = false; });

    // --- Secure Flashing Logic (kept for easy re-enable) ---
    const PSK_LENGTH = 16;
    const PATCH_MAGIC = new Uint8Array([ 0xDE, 0xAD, 0xBE, 0xEF ]);
    const DEFAULT_PSK = new Uint8Array([
      0x7C, 0xE3, 0x91, 0x2F, 0xA8, 0x5D, 0xB4, 0x69,
      0x3E, 0xC7, 0x14, 0xF2, 0x86, 0x0B, 0xD9, 0x4A
    ]);

    // Concatenate them to create the *actual* search needle
    const searchNeedle = new Uint8Array(PATCH_MAGIC.length + DEFAULT_PSK.length);
    searchNeedle.set(PATCH_MAGIC, 0);
    searchNeedle.set(DEFAULT_PSK, PATCH_MAGIC.length);

    function findSubarray(haystack, needle) {
      for (let i = 0; i <= haystack.length - needle.length; i++) {
        let found = true;
        for (let j = 0; j < needle.length; j++) {
          if (haystack[i + j] !== needle[j]) { found = false; break; }
        }
        if (found) return i;
      }
      return -1;
    }

    function generateHexKey(length) {
      const bytes = new Uint8Array(length);
      window.crypto.getRandomValues(bytes);
      return Array.from(bytes).map(b => b.toString(16).padStart(2, '0')).join('').toUpperCase();
    }

    async function prepareSecureFirmware() {
      // If the whole feature is forcibly disabled, bail out.
      if (DISABLE_SECURE_MODE && !isSecureModeEnabled) return;
      const flashBtn = document.getElementById('flashBtn');
      log('Preparing Secure Firmware for this session...');
      if(flashBtn) flashBtn.disabled = true;
      downloadSecureBtn.disabled = true;
      sessionPskDisplay.textContent = 'Generating key and patching firmware...';
      sessionPskDisplay.style.color = 'var(--medium-text)';

      if (patchedFirmwareUrl) {
        URL.revokeObjectURL(patchedFirmwareUrl);
      }
      
      try {
        if (!sessionPsk) {
            sessionPsk = generateHexKey(PSK_LENGTH);
            sessionStorage.setItem('sessionPsk', sessionPsk);
            log('üîë Generated new Secure Session PSK and saved to session storage.');
        } else {
             log('üîë Loaded existing Secure Session PSK from session storage.');
        }

        const obfuscatedPsk = '**************************' + sessionPsk.slice(-6);
        log('****************************************************************');
        log(`üîí Current Secure Session PSK: ${obfuscatedPsk}`);
        log('   This key will be used for all devices flashed in this session.');
        log('****************************************************************');
        sessionPskDisplay.textContent = `Session PSK: ${obfuscatedPsk}`;
        sessionPskDisplay.style.color = 'var(--light-text)';

        // *** MODIFIED to add cache-buster ***
        const manifest = await (await fetch('./manifest.json?t=' + Date.now())).json();
        const firmwarePart = manifest.builds[0].parts.find(part => part.path.includes("sketch_jun11a.ino.merged.bin"));
        if (!firmwarePart) throw new Error("Could not find firmware part in manifest.");
        
        // *** MODIFIED to add cache-buster ***
        const response = await fetch(firmwarePart.path + '?t=' + Date.now());
        if (!response.ok) throw new Error(`Failed to fetch firmware: ${response.statusText}`);
        const firmwareData = new Uint8Array(await response.arrayBuffer());

        log('Searching for patchable PSK (magic + key) in firmware binary...');
        const pskOffset = findSubarray(firmwareData, searchNeedle); 

        if (pskOffset === -1) {
          throw new Error("Patchable PSK (magic+key) not found. Is the C++ sketch modified? Is it already patched?");
        }

        const patchKeyOffset = pskOffset + PATCH_MAGIC.length;
        log(`‚úÖ Patchable target found at offset 0x${pskOffset.toString(16)}. Patching key at 0x${patchKeyOffset.toString(16)}...`);

        const pskBytes = new Uint8Array(PSK_LENGTH);
        for (let i = 0; i < PSK_LENGTH; i++) {
          pskBytes[i] = parseInt(sessionPsk.substring(i * 2, i * 2 + 2), 16);
        }
        
        firmwareData.set(pskBytes, patchKeyOffset);

        const patchedBlob = new Blob([firmwareData], { type: 'application/octet-stream' });
        patchedFirmwareUrl = URL.createObjectURL(patchedBlob);
        
        log('‚úÖ Secure firmware is generated and ready to be flashed.');
        if(flashBtn) flashBtn.disabled = false;
        downloadSecureBtn.disabled = false;

        // *** ADDED: Set manifest *after* blob is ready ***
        // Now that the blob is ready, set the manifest on the component
        // to wake it up and make it ready to flash.
        if (installButton) {
          installButton.manifest = './manifest.json?t=' + Date.now();
        }
        // *** END ADDED BLOCK ***

      } catch(e) {
        log(`Error preparing secure firmware: ${e.message}`, 'error');
        sessionPskDisplay.textContent = "Error! Check console.";
        sessionPskDisplay.style.color = 'var(--error-color)';
        if(flashBtn) flashBtn.disabled = true;
      }
    }

    function createFlasherComponent() {
      buttonContainer.innerHTML = '';
      const newInstallButton = document.createElement('esp-web-install-button');
      newInstallButton.patchManifest = patchManifestFn;
      newInstallButton.addEventListener('state-changed', onStateChanged);
      newInstallButton.addEventListener('error', onError);

      // *** MODIFIED LOGIC ***
      const modeEl = document.querySelector('input[name="flashMode"]:checked');
      const mode = modeEl ? modeEl.value : 'compatibility';

      // Only set the manifest immediately if in compatibility mode.
      // This prevents the pre-fetch/cache in Secure Mode.
      if (mode === 'compatibility') {
        newInstallButton.manifest = './manifest.json?t=' + Date.now(); // Added cache-buster
      }
      // *** END MODIFIED LOGIC ***

      newInstallButton.innerHTML = `<button slot="activate" id="flashBtn" class="btn">‚ö° Flash Firmware</button>`;
      buttonContainer.appendChild(newInstallButton);
      installButton = newInstallButton;
      isResetting = false;

      if (document.querySelector('input[name="flashMode"]:checked') && document.querySelector('input[name="flashMode"]:checked').value === 'secure') {
          installButton.querySelector('button').disabled = true;
          log("Secure mode: Waiting for firmware patch...");
      }
    }

    const patchManifestFn = (manifest) => {
      // *** FIX: Create a deep copy of the manifest to avoid modifying the original object. ***
      const manifestCopy = JSON.parse(JSON.stringify(manifest));
      const firmwarePart = manifestCopy.builds[0].parts.find(part => part.path.includes("sketch_jun11a.ino.merged.bin"));

      if (!firmwarePart) {
          log('Could not find the default firmware binary in the manifest.', 'error');
          throw new Error("Firmware part not found in manifest.");
      }
      
      // Check if we are in "upload from file" mode first
      if (sessionStorage.getItem('uploadMode') === 'true') {
        sessionStorage.removeItem('uploadMode'); // Clean up the flag
        if (!uploadedFileUrl) {
          log('No uploaded file is available to flash.', 'error');
          throw new Error("Uploaded file not ready.");
        }
        log(`Flashing from user-uploaded file: ${firmwareUpload.files[0].name}`);
        firmwarePart.path = uploadedFileUrl;
        return manifestCopy;
      }

      // Original logic for radio buttons
      const modeEl = document.querySelector('input[name="flashMode"]:checked');
      const mode = modeEl ? modeEl.value : 'compatibility';
      if (mode === 'compatibility') { 
        log('Flashing in Compatibility Mode (using default PSK)');
        // *** ADD cache-buster to compatibility mode path ***
        firmwarePart.path = firmwarePart.path + '?t=' + Date.now();
        return manifestCopy;
      }
      if (mode === 'secure') {
        if (!patchedFirmwareUrl || !sessionPsk) {
          log('Secure firmware has not been generated. Cannot flash.', 'error');
          throw new Error("Secure firmware not ready.");
        }
        const obfuscatedPsk = '**************************' + sessionPsk.slice(-6);
        log(`Flashing in Secure Mode with session PSK: ${obfuscatedPsk}`);
        firmwarePart.path = patchedFirmwareUrl;
        return manifestCopy;
      }
    };

    const onStateChanged = (e) => {
      const state = e.detail;
      if (isResetting) return;
      log(`State: ${state}`);
      
      const isWorking = ['PREPARING', 'UPLOADING', 'INITIALIZING'].includes(state);
      bootPrompt.classList.toggle('show', isWorking);

      const isFinished = ['FINISHED', 'ERROR', 'DASHBOARD'].includes(state);

      if (isFinished) {
        sessionStorage.removeItem('uploadMode'); 
        if (isResetting) return;
        isResetting = true;

        if (state === 'FINISHED') {
          log('‚úÖ Flash complete! Press RESET button on ESP32.', 'success');
          log('   Tool is resetting. Ready for the next device...');
          alert("Flash Complete! The tool has reset for the next device. If you cannot flash the next device (e.g., the browser does not show the port selection dialog), please refresh the page and try again.");
        } else if (state === 'ERROR') {
          log('‚ùå Flash failed. Try unplugging/replugging the device and the BOOT button procedure.', 'error');
          log('   Tool is resetting...');
        } else if (state === 'DASHBOARD') {
           log('‚ÑπÔ∏è Operation cancelled or closed. Resetting tool...');
        }
        
        setTimeout(() => {
          const dialog = document.querySelector("ewt-dialog");
          if (dialog) { dialog.close(); }
          createFlasherComponent();
          initFlashMode();
        }, 1500);
      }
    };

    const onError = (e) => {
      if (isResetting) return;
      log(`Error: ${e.detail.message || e.detail}`, 'error');
    };

    function initFlashMode() {
        // Update override button based on persistent flag
        if (localStorage.getItem('isSecureModeEnabled') === 'true') {
            overrideSecureBtn.textContent = 'Disable Secure Mode and Reload';
            overrideSecureBtn.classList.remove('btn-secondary');
            overrideSecureBtn.style.backgroundColor = '#444'; // neutral color
        } else {
            overrideSecureBtn.textContent = 'Enable Secure Mode and Reload';
            overrideSecureBtn.classList.add('btn-secondary');
            overrideSecureBtn.style.backgroundColor = ''; // revert
        }

        // If a temporary session override exists, show that in the UI too
        const isTemp = sessionStorage.getItem('isSecureModeTemp') === 'true';
        if (isTemp && !localStorage.getItem('isSecureModeEnabled')) {
            // indicate that secure mode is active for this session
            overrideSecureBtn.textContent = 'Secure Mode active for this session';
            overrideSecureBtn.classList.remove('btn-secondary');
            overrideSecureBtn.style.backgroundColor = '#2a7a2a';
        }

        // IMPORTANT: keep the Secure radio interactive so we can intercept clicks and show modal.
        // Do not disable the radio element; we will intercept activations to show the override flow.
        radioSecure.disabled = false;

        // If secure mode is not enabled (persistently or session), show message and default to compatibility UI
        if (!isSecureModeEnabled) {
            radioCompatibility.checked = true; // Default to compatibility
            secureModeControls.style.display = 'none';
            secureModeDisabledMessage.style.display = 'block'; // Show the message with the toggle button
            compatibilityModeControls.style.display = 'block'; // Show compatibility controls
            
            log('Secure Mode is currently disabled. Use the toggle button or choose a session override to enable it.', 'info');
            const flashBtn = document.getElementById('flashBtn');
            if (flashBtn) flashBtn.disabled = false; // Compatibility mode is ready
            return;
        }

        // If isSecureModeEnabled is true, proceed to normal state management
        radioSecure.disabled = false; // Ensure radio is enabled
        secureModeDisabledMessage.style.display = 'none'; // Hide disabled message

        let savedMode = sessionStorage.getItem('flashMode') || 'compatibility';
        
        if (savedMode === 'secure') {
            radioSecure.checked = true;
            secureModeControls.style.display = 'block';
            compatibilityModeControls.style.display = 'none';
        } else {
            radioCompatibility.checked = true;
            secureModeControls.style.display = 'none';
            compatibilityModeControls.style.display = 'block';
        }
        
        const flashBtn = document.getElementById('flashBtn');
        if (savedMode === 'secure') {
            if(flashBtn) flashBtn.disabled = true;
            prepareSecureFirmware();
        } else {
            if(flashBtn) flashBtn.disabled = false;
        }
    }
    
    // --- UI Event Listeners ---

    // Toggle Button Listener - FLIPS PERSISTENT STATE AND RELOADS PAGE
    overrideSecureBtn.addEventListener('click', () => {
        // Flip persistent state
        const currentlyPersistent = localStorage.getItem('isSecureModeEnabled') === 'true';
        const newState = !currentlyPersistent;
        localStorage.setItem('isSecureModeEnabled', newState.toString());
        
        // Remove temporary session override if it exists, as the persistent flag is now active.
        sessionStorage.removeItem('isSecureModeTemp');

        log(`Toggled persistent Secure Mode to: ${newState ? 'Enabled' : 'Disabled'}. Reloading page...`, 'info');
        window.location.reload();
    });

    // Modal control helpers
    function showOverrideModal() {
        secureOverrideModal.classList.add('show');
        secureOverrideModal.setAttribute('aria-hidden', 'false');
    }
    function hideOverrideModal() {
        secureOverrideModal.classList.remove('show');
        secureOverrideModal.setAttribute('aria-hidden', 'true');
    }

    enableSessionBtn.addEventListener('click', () => {
        // Enable secure mode for this session only (no reload).
        sessionStorage.setItem('isSecureModeTemp', 'true');
        isSecureModeEnabled = true;
        hideOverrideModal();
        log('Secure Mode enabled for this session (temporary). Initializing secure mode...', 'info');
        initFlashMode();
        // If user already selected secure radio, ensure UI shows secure mode controls
        sessionStorage.setItem('flashMode', 'secure');
        radioSecure.checked = true;
        secureModeControls.style.display = 'block';
        compatibilityModeControls.style.display = 'none';
        
        // *** MODIFIED: Manually call component recreation and secure prep ***
        log('Mode changed. Re-initializing flasher component...');
        createFlasherComponent();
        const newFlashBtn = document.getElementById('flashBtn');
        if (newFlashBtn) newFlashBtn.disabled = true;
        prepareSecureFirmware();
    });

    // Removed: enablePermanentBtn.addEventListener('click', ...)

    cancelOverrideBtn.addEventListener('click', () => {
        hideOverrideModal();
        // Ensure compatibility remains selected
        radioCompatibility.checked = true;
        sessionStorage.setItem('flashMode', 'compatibility');
        log('Secure Mode selection cancelled. Staying in Compatibility Mode.', 'info');
    });

    // Intercept mouse/keyboard activation of Secure radio so we can show modal
    radioSecure.addEventListener('mousedown', (e) => {
        if (!isSecureModeEnabled) {
            e.preventDefault(); // Prevent the radio from being selected by mouse
            log('Intercepted Secure radio click - showing override modal.', 'info');
            showOverrideModal();
        }
    });
    // keyboard accessibility: intercept space/enter
    radioSecure.addEventListener('keydown', (e) => {
        if (!isSecureModeEnabled && (e.key === ' ' || e.key === 'Enter')) {
            e.preventDefault();
            log('Intercepted Secure radio keyboard activation - showing override modal.', 'info');
            showOverrideModal();
        }
    });

    // *** MODIFIED: This listener now recreates the component on change ***
    document.querySelectorAll('input[name="flashMode"]').forEach(radio => {
      radio.addEventListener('change', (e) => {
        const mode = e.target.value;

        if (mode === 'secure' && !isSecureModeEnabled) {
            // do not allow immediate selection; prompt user for override choices
            radioCompatibility.checked = true; // keep compatibility selected while user decides
            log('Secure Mode is currently disabled. Prompting for override options...', 'info');
            showOverrideModal();
            // keep session storage as compatibility for now
            sessionStorage.setItem('flashMode', 'compatibility');
            return;
        }

        sessionStorage.setItem('flashMode', mode);
        const isSecureMode = mode === 'secure';

        secureModeControls.style.display = isSecureMode ? 'block' : 'none';
        compatibilityModeControls.style.display = isSecureMode ? 'none' : 'block';
        secureModeDisabledMessage.style.display = 'none'; // Ensure message is hidden if secure mode is enabled

        // *** ADDED: Re-create the flasher component to bust its internal cache ***
        log('Mode changed. Re-initializing flasher component...');
        createFlasherComponent(); 
        // *** END ADDED BLOCK ***

        // Now, get the *new* button and apply logic
        const newFlashBtn = document.getElementById('flashBtn');
        if (isSecureMode) {
          if(newFlashBtn) newFlashBtn.disabled = true; // Button is disabled by default in createFlasherComponent
          prepareSecureFirmware(); // This will create the blob and re-enable the button
        } else if (newFlashBtn) {
          newFlashBtn.disabled = false;
        }
      });
    });

    downloadSecureBtn.addEventListener('click', () => {
        if (!patchedFirmwareUrl || !sessionPsk) {
            log('Secure firmware not available for download.', 'error');
            return;
        }
        const a = document.createElement('a');
        a.href = patchedFirmwareUrl;
        a.download = `secure_firmware_${sessionPsk.slice(-6)}.bin`;
        document.body.appendChild(a);
        a.click();
        document.body.removeChild(a);
        log(`Downloading secure firmware: ${a.download}`);
    });

    clearPskBtn.addEventListener('click', () => {
        if (!isSecureModeEnabled) return; // Guard 
        if (!confirm('Are you sure you want to clear the current session key? This will require you to re-flash ALL your devices with the new key.')) {
            return;
        }
        sessionStorage.removeItem('sessionPsk');
        sessionPsk = null; 
        patchedFirmwareUrl = null; 
        log('Security key cleared. A new key will be generated immediately.');
        sessionPskDisplay.textContent = 'Session PSK cleared. Generating new key...';
        sessionPskDisplay.style.color = 'var(--medium-text)';
        downloadSecureBtn.disabled = true;
        const flashBtn = document.getElementById('flashBtn');
        if (document.querySelector('input[name="flashMode"]:checked').value === 'secure') {
            if(flashBtn) flashBtn.disabled = true;
            prepareSecureFirmware();
        }
    });

    // NEW: Event listeners for advanced upload functionality
    firmwareUpload.addEventListener('change', () => {
        if (firmwareUpload.files.length > 0) {
            const file = firmwareUpload.files[0];
            if (uploadedFileUrl) {
                URL.revokeObjectURL(uploadedFileUrl); // Clean up previous blob URL
            }
            uploadedFileUrl = URL.createObjectURL(file);
            flashUploadedBtn.disabled = false;
            log(`Selected file for upload: ${file.name}`);
        } else {
            uploadedFileUrl = null;
            flashUploadedBtn.disabled = true;
        }
    });

    flashUploadedBtn.addEventListener('click', () => {
        if (!uploadedFileUrl) {
            alert('Please select a .bin file to flash first.');
            return;
        }
        // Set a flag to tell the patcher function which mode we're in
        sessionStorage.setItem('uploadMode', 'true');
        // Trigger the main flasher button's click event
        if (installButton) {
            
            // *** MODIFIED to add cache-buster ***
            installButton.manifest = './manifest.json?t=' + Date.now();
            
            installButton.querySelector('button').click();
        } else {
            log('Flasher component not ready.', 'error');
        }
    });

    // *** MODIFIED: Added cache-busters to initial setup ***
    (async () => {
      try {
        const cacheBust = '?t=' + Date.now(); // Define cache-buster
        const manifestRes = await fetch('./manifest.json' + cacheBust); // MODIFIED
        if (!manifestRes.ok) throw new Error(`manifest.json HTTP ${manifestRes.status}`);
        log('manifest.json found');
        const firmwareRes = await fetch('./sketch_jun11a.ino.merged.bin' + cacheBust, { method: 'HEAD' }); // MODIFIED
        if (!firmwareRes.ok) throw new Error(`sketch_jun11a.ino.merged.bin HTTP ${firmwareRes.status}`);
        log('sketch_jun11a.ino.merged.bin found');
      } catch (e) {
        log(e.message, 'error');
      }
      createFlasherComponent();
      initFlashMode();
      log('Ready to flash. Select a mode and click the button to begin.');
    })();

  </script>
</body>
</html>

<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Protest Node Flash Tool</title>
  <link rel="icon" href="ico.png" type="image/png">
  <style>
    :root {
      --primary-color: #0066cc;
      --primary-hover: #0052a3;
      --secondary-color: #c60;
      --secondary-hover: #a50;
      --dark-bg: #222;
      --medium-bg: #333;
      --light-text: #eee;
      --medium-text: #aaa;
      --dark-text: #111;
      --border-color: #444;
      --success-color: #0f0;
      --error-color: #f55;
    }
    * { box-sizing: border-box; }
    body {
      background: var(--dark-bg);
      color: var(--light-text);
      font-family: Arial, sans-serif;
      margin: 0;
      padding: 0;
      height: 100vh;
      overflow: hidden;
      display: flex;
    }
    .main-content {
      flex: 1;
      padding: 20px;
      overflow-y: scroll;
      height: 100vh;
      transition: margin-left 0.3s ease;
    }
    .main-content.console-open {
      margin-left: 450px;
    }
    .container {
      max-width: 900px; /* The maximum width of the content area */
      margin: 0 auto;
      padding-bottom: 40px;
    }
    h1 {
      text-align: center;
      margin: 20px 0 30px 0;
      font-size: 32px;
    }
    
    .info-box {
      background: var(--medium-bg);
      border-radius: 8px;
      padding: 20px;
      margin: 20px auto 20px auto; 
      border: 1px solid var(--border-color);
    }

    .info-row {
      display: flex;
      justify-content: space-between;
      margin: 8px 0;
      font-size: 14px;
    }
    
    .info-label { 
      color: var(--medium-text);
      flex-shrink: 0; 
      padding-right: 15px; 
    }
    .info-value { 
      font-weight: bold;
      text-align: right; 
      overflow-wrap: break-word; 
      word-break: break-word; 
      min-width: 0; /* ADDED: Allows flex item to shrink below content size and wrap */
    }
    
    .status-good { color: var(--success-color); }
    .status-bad { color: var(--error-color); }
    
    .button-container {
      text-align: center;
      margin: 30px 0;
    }
    
    .flash-mode-section {
      background: var(--medium-bg);
      border: 1px solid var(--border-color);
      border-radius: 8px;
      padding: 20px;
      margin: 20px auto; /* Centers the block, allowing it to take full container width */
      text-align: center;
    }
    .flash-mode-section label {
      margin: 0 15px;
      font-size: 14px;
      cursor: pointer;
    }
    .flash-mode-section input {
      margin-right: 8px;
      vertical-align: middle;
    }

    /* Base styles for all primary action buttons */
    .btn {
      color: #fff;
      border: none;
      padding: 15px 40px;
      font-size: 18px;
      font-weight: bold;
      border-radius: 8px;
      cursor: pointer;
      transition: background-color 0.2s, transform 0.1s;
    }
    .btn:hover {
      transform: translateY(-2px);
    }
    .btn:active {
      transform: translateY(0px);
    }
    .btn:disabled {
      background-color: #555 !important;
      cursor: not-allowed;
      transform: none;
    }

    /* Flasher Button */
    #flashBtn {
      background: var(--primary-color);
    }
    #flashBtn:hover:not(:disabled) {
      background: var(--primary-hover);
    }
    
    /* Secondary buttons, e.g., download */
    .btn-secondary {
      background: var(--secondary-color);
      color: var(--dark-text); /* Ensure dark text for contrast on lighter secondary color */
      padding: 12px 24px;
      font-size: 16px;
    }
    .btn-secondary:hover:not(:disabled) {
      background: var(--secondary-hover);
    }
    
    /* Style for Neutral/Dark Buttons */
    .btn-neutral {
        background: #444;
        color: var(--light-text); 
    }
    .btn-neutral:hover:not(:disabled) {
        background: #555;
    }
    
    .warning {
      background: #553300;
      color: #ff9;
      border-left: 4px solid #fb923c;
      padding: 15px 20px;
      border-radius: 6px;
      margin: 20px auto; /* Centers the block, allowing it to take full container width */
      font-size: 14px;
    }
    
    .boot-prompt {
      background: #004488;
      color: #fff;
      border-left: 4px solid #0088ff;
      padding: 15px 20px;
      border-radius: 6px;
      margin: 20px auto; /* Centers the block, allowing it to take full container width */
      font-size: 14px;
      display: none;
    }
    .boot-prompt.show { display: block; }
    
    .instructions {
      background: var(--medium-bg);
      border-radius: 8px;
      padding: 20px;
      margin: 20px auto 0 auto; /* MODIFIED: Changed top margin from 30px to 20px */
      font-size: 14px;
      line-height: 1.6;
      border: 1px solid var(--border-color);
    }

    .mode-explainer {
      background: linear-gradient(135deg, rgba(0, 102, 204, 0.1), rgba(204, 102, 0, 0.1));
      border: 1px solid var(--border-color);
      border-radius: 8px;
      padding: 18px 20px;
      margin: 20px auto; /* Centers the block, allowing it to take full container width */
      font-size: 13px;
      line-height: 1.5;
    }
    
    .mode-explainer h4 {
      margin: 0 0 12px 0;
      font-size: 15px;
      color: var(--light-text);
      display: flex;
      align-items: center;
      gap: 8px;
    }
    
    .mode-grid {
      display: grid;
      grid-template-columns: 1fr 1fr;
      gap: 15px;
      margin-top: 12px;
    }
    
    .mode-card {
      background: rgba(0, 0, 0, 0.3);
      border: 1px solid var(--border-color);
      border-radius: 6px;
      padding: 12px;
    }
    
    .mode-card h5 {
      margin: 0 0 8px 0;
      font-size: 14px;
      color: #8ab4f8;
    }
    
    .mode-card p {
      margin: 0;
      color: var(--medium-text);
      font-size: 12px;
      line-height: 1.4;
    }

    .psk-display-wrapper {
        display: flex;
        justify-content: center;
        align-items: center;
        margin-top: 20px;
        gap: 10px;
    }
    
    #sessionPskDisplay {
        font-family: 'Consolas', monospace;
        font-size: 14px;
        background: var(--dark-text);
        padding: 10px;
        border-radius: 4px;
        border: 1px solid var(--border-color);
        color: var(--light-text);
        flex-grow: 1;
        max-width: 400px;
        text-align: left;
    }

    #clearPskBtn {
        background: var(--medium-bg);
        color: var(--secondary-color);
        border: 1px solid var(--border-color);
        width: 40px;
        height: 40px;
        padding: 0;
        border-radius: 50%;
        font-size: 20px;
        line-height: 1;
        display: flex;
        justify-content: center;
        align-items: center;
        transition: background-color 0.2s, color 0.2s;
        flex-shrink: 0;
    }
    #clearPskBtn:hover {
        background: var(--secondary-color);
        color: var(--light-text);
        transform: rotate(-30deg);
        transform-origin: center;
    }

    .advanced-section {
        background: var(--medium-bg);
        border: 1px solid var(--border-color);
        border-radius: 8px;
        margin: 20px auto; /* Centers the block, allowing it to take full container width */
    }
    .advanced-section summary {
        position: relative;
        z-index: 100;
        font-size: 16px;
        font-weight: bold;
        padding: 15px 20px;
        cursor: pointer;
        outline: none;
    }
    .advanced-section summary::-webkit-details-marker {
        color: var(--secondary-color);
    }
    .advanced-content {
        padding: 0 20px 20px 20px;
        border-top: 1px solid var(--border-color);
    }
    .advanced-content p {
        font-size: 13px;
        color: var(--medium-text);
        margin-bottom: 15px;
    }
    .advanced-content input[type="file"] {
        margin: 10px auto;
        display: block;
    }
    .btn-advanced {
        background: #444;
        margin-top: 10px;
    }
    .btn-advanced:hover:not(:disabled) {
        background: #555;
    }
    
    /* Styles for subsections within Advanced */
    .advanced-subsection {
        border: 1px solid var(--border-color);
        border-radius: 6px;
        padding: 15px;
        margin-top: 20px;
        background: rgba(0,0,0,0.2);
    }
    .advanced-subsection h4 {
        margin-top: 0;
        color: var(--light-text);
        border-bottom: 1px solid var(--border-color);
        padding-bottom: 8px;
    }
    
    .header-link {
        position: absolute;
        top: 20px;
        right: 20px; 
        color: var(--medium-text);
        text-decoration: none;
        font-size: 14px;
        transition: color 0.2s;
    }
    .header-link:hover {
        color: var(--light-text);
    }
    .header-link span {
        margin-left: 5px;
    }
    /* ADDED STYLES FOR SECOND HEADER LINK */
    .header-link-left {
        position: absolute;
        top: 20px;
        left: 20px;
        color: var(--medium-text);
        text-decoration: none;
        font-size: 14px;
        transition: color 0.2s;
    }
    .header-link-left:hover {
        color: var(--light-text);
    }
    .header-link-left span {
        margin-right: 5px;
    }
    /* END ADDED STYLES */

    /* Class for Secure Mode Box */
    .secure-mode-box {
        background: var(--medium-bg);
        border: 1px solid var(--border-color);
        border-radius: 8px;
        padding: 20px;
        margin: 20px auto; /* Centers the block, allowing it to take full container width */
        text-align: center;
    }

    @media (max-width: 768px) {
      .mode-grid {
        grid-template-columns: 1fr;
      }
      .header-link {
        top: 10px;
        right: 10px;
      }
      /* Adjust for small screens */
      .header-link-left {
        top: 40px; /* Push down to clear logo/title area if necessary */
        left: 10px;
      }
    }
    
    /* Console Panel - Left Side */
    .log-container {
      position: fixed; top: 0; left: 0; bottom: 0;
      width: 450px;
      background: #1a1a1a;
      border-right: 2px solid var(--border-color);
      display: flex; flex-direction: column;
      transition: transform 0.3s ease;
      z-index: 1000;
    }
    .log-container.minimized {
      transform: translateX(calc(-100% + 50px));
    }
    .log-container.minimized .resize-handle { display: none; }
    .log-container.minimized .log-header {
      position: absolute;
      right: 0;
      top: 0;
      cursor: pointer;
      writing-mode: vertical-rl;
      text-orientation: mixed;
      width: 50px;
      padding: 15px 10px;
      border-bottom: none;
    }
    .log-container.minimized .log-header:hover { background: var(--primary-color); }
    .log-container.minimized .log-header h3 { transform: rotate(180deg); }
    .log-container.minimized .log-content { display: none; }
    
    .resize-handle {
      position: absolute; right: 0; top: 0; bottom: 0;
      width: 6px; cursor: ew-resize; z-index: 10;
      left: auto;
    }
    
    .log-header {
      display: flex; justify-content: space-between; align-items: center;
      padding: 15px 20px; background: #2a2a2a;
      user-select: none; flex-shrink: 0;
      border-bottom: 1px solid var(--border-color); cursor: pointer;
    }
    .log-header h3 { margin: 0; font-size: 16px; }
    .log-content { flex: 1; padding: 15px; overflow-y: auto; overflow-x: hidden; }
    pre {
      background: #000; color: var(--success-color);
      font-family: 'Consolas', 'Monaco', monospace; white-space: pre-wrap;
      word-wrap: break-word; border: 1px solid var(--border-color);
      border-radius: 6px; padding: 12px; margin: 0;
      font-size: 12px; line-height: 1.5;
    }
    
    @media (max-width: 1024px) {
      body { flex-direction: column; }
      .main-content { height: auto; min-height: calc(100vh - 300px); margin-left: 0 !important; }
      .main-content.console-open { margin-bottom: 300px; }
      .log-container {
        position: fixed; top: auto; right: 0; bottom: 0; left: 0;
        width: auto !important; height: 300px;
        border-right: none; border-top: 2px solid var(--border-color);
      }
      .log-container.minimized { transform: translateY(calc(100% - 50px)); }
      .log-container.minimized .log-header {
          position: static; /* Revert for bottom bar layout */
          writing-mode: horizontal-tb;
          width: auto;
          padding: 12px 20px;
      }
      .log-container.minimized .log-header h3 { transform: none; }
      .resize-handle {
        left: 0; right: 0; top: 0; bottom: auto;
        width: auto; height: 6px; cursor: ns-resize;
      }
    }
  </style>
  
  <script type="module" src="https://unpkg.com/esp-web-tools@10/dist/web/install-button.js?module"></script>
</head>
<body>
  <div class="main-content" id="mainContent">
    <div class="container">
      <a href="index.html" class="header-link">
        Back to Project Home <span>&larr;</span>
      </a>
      <a href="directions.html" class="header-link-left">
        <span>&rarr;</span> Advanced Flashing Directions
      </a>
      <h1>Protest Node Flash Tool</h1>
      
      <div class="warning">
        <strong>⚠️ Before flashing:</strong>
        <ul>
          <li>Close any serial monitor programs (Arduino IDE, PuTTY, etc.)</li>
          <li>Close any other browser tabs using the ESP32</li>
          <li>Unplug and replug your ESP32 if needed</li>
		  <li>If you have trouble connecting to the next device after a flash (if applicable) refresh the web page.</li>
        </ul>
      </div>

      <div class="mode-explainer">
        <h4>🔐 Understanding Flash Modes</h4>
        <div class="mode-grid">
          <div class="mode-card">
            <h5>Compatibility Mode</h5>
            <p>Uses the default symmetric key included in the public code. Suitable for testing but not secure for production deployment. All devices share the same PSK (encryption password, essentially). This means an adversary can extract the key from your source or firmware and inject or intercept traffic. This may be acceptable for testing or smaller events less likely to be directly targeted. The benefit is it’s easy to expand and use (you won’t have to reflash all your devices when you add more nodes or figure out how to use a BIN file). <a href="directions.html#compatibility-mode" style="color: var(--secondary-color);">See full Compatibility Mode instructions.</a></p>
          </div>
          <div class="mode-card">
            <h5>Secure Mode (Recommended)</h5>
            <p>This process requires you to **download a compiler kit** to create a unique, secure firmware file on your computer. The private key is generated locally and never leaves your machine. The build and flash process is entirely handled on your local machine using the kit. All nodes must be flashed with the resulting unique C<code>.bin</code> file. <a href="directions.html#secure-mode" style="color: var(--secondary-color);">See full Secure Mode instructions.</a></p>
          </div>
        </div>
      </div>

      <div class="boot-prompt" id="bootPrompt">
        <strong>🔄 Press BOOT button on your ESP32</strong>
        <p>If flashing fails or times out, you may need to manually enter boot mode.</p>
      </div>

      <div class="flash-mode-section">
        <label><input type="radio" name="flashMode" value="compatibility" id="radioCompatibility"> Compatibility Mode</label>
        <label><input type="radio" name="flashMode" value="secure" id="radioSecure"> Secure Mode</label>
      </div>
      
      <div class="button-container" id="buttonContainer">
      </div>
      
      <div id="compatibility-mode-controls" style="text-align: center; margin: 20px 0;">
         <a href="./sketch_jun11a.ino.merged.bin" download="unmodified_firmware.bin" style="text-decoration: none;">
            <button class="btn btn-secondary">Download Unmodified Firmware</button>
         </a>
         <p style="font-size: 12px; color: var(--error-color); margin-top: 10px; max-width: 450px; margin-left: auto; margin-right: auto;">
            <strong>Warning:</strong> This firmware is unmodified and uses a default, insecure key. It should only be used for testing purposes.
         </p>
      </div>
      
      <div id="secure-mode-workflow" class="secure-mode-box" style="display: none;">
          <h3 style="margin-top: 0;">Secure Mode: Build Firmware Locally</h3>
          <p style="color: var(--medium-text); margin: 0 auto 20px auto;">
            This is the recommended method for secure deployment. You must build the firmware on your computer to generate a unique key. The final flashing step is also completed on your workstation using the tools provided in the kit.
          </p>
          <a href="mesh.zip" download style="text-decoration: none;">
            <button class="btn btn-secondary" style="font-size: 18px; padding: 15px 30px;">
                Download Secure Flasher Kit (mesh.zip)
            </button>
          </a>
          <div style="text-align: left; max-width: 600px; margin: 20px auto 0 auto; font-size: 14px; line-height: 1.6; border-top: 1px solid var(--border-color); padding-top: 15px;">
            <strong>Process:</strong>
            <ol>
                <li>Download and extract the <code>mesh.zip</code> file.</li>
                <li>Follow the <code>README.md</code> file inside to run the build script. This will generate a new, secure <code>firmware.bin</code> file and a script to flash it.</li>
                <li>**The flashing process is performed on your computer** using the generated script (e.g., a Python or batch file). This web tool is no longer needed after the download.</li>
                <li>Use that same <code>.bin</code> file for all nodes in your mesh.</li>
            </ol>
            <p style="margin-top: 15px;"><a href="directions.html#secure-mode" style="color: var(--secondary-color); font-weight: bold;">See the complete Secure Mode build and flash guide here.</a></p>
          </div>
          
      </div>

      <details class="advanced-section">
        <summary>Advanced Options (Experimental)</summary>
        <div class="advanced-content">
                    
            <div class="advanced-subsection">
                <h4>Experimental: In-Browser Secure Flashing (Dev Only)</h4>
                <p>
                    This feature attempts to generate a key and patch firmware directly in your browser. It is for development and testing only and is <strong>not guaranteed to be secure or functional.</strong> The recommended path is the "Secure Mode" offline build process. <a href="directions.html#experimental-mode" style="color: var(--secondary-color);">See details on this experimental mode.</a>
                </p>
				<center>
                <button id="initExperimentalBtn" class="btn btn-advanced" style="background-color: var(--secondary-color); color: var(--dark-text);">
                    Initialize Experimental Flasher
                </button>
                
                <div id="experimental-secure-controls" style="margin: 20px 0;">
                    <button id="downloadSecureBtn" class="btn btn-secondary" disabled>
                      Download Patched Secure Firmware
                    </button>
                    </center>
                    <div class="psk-display-wrapper">
                        <div id="sessionPskDisplay">
                          Session PSK will be generated automatically...
                        </div>
                         <button id="clearPskBtn" title="Start New Secure Session (Clear Key)">
                            &#x21BB; </button>
                    </div>
                </div>
                
                <div id="experimental-button-container" style="text-align: center; margin-top: 15px;">
                    </div>
            </div>
            
        </div>
      </details>
      <div class="instructions">
        <h3>📋 Instructions</h3>
        <p>For a full, detailed guide on all flashing procedures, please visit the <a href="directions.html" style="color: var(--secondary-color); font-weight: bold;">Advanced Flashing Directions page</a>.</p>
        <ol>
          <li>Connect your ESP32 to your computer via USB.</li>
          <li>Select your flashing mode:
            <ul>
                <li><strong>Compatibility Mode:</strong> The "Flash Firmware" button will appear. Follow the instructions below.</li>
                <li><strong>Secure Mode:</strong> Download the <code>mesh.zip</code> kit and follow the instructions to build and flash the firmware on your workstation. This web tool is **not** used for flashing in this mode.</li>
            </ul>
          </li>
          <li>For **Compatibility Mode** (and Experimental Mode): Click the **Flash Firmware** button and select the ESP32 port from the popup.</li>
          <li>For **Secure Mode**: Follow the instructions provided in the downloaded kit (<code>mesh.zip</code>) to build and flash the firmware on your computer.</li>
          <li>Wait for flashing to complete. </li>
          <li>Press RESET on your ESP32 after the flash is complete. </li>
		  <li>If you have trouble connecting to the next device (if applicable) refresh the web page.</li>
        </ol>
      </div>

      <div class="info-box">
        <div class="info-row"><span class="info-label">User Agent:</span><span class="info-value" id="browser"></span></div>
        <div class="info-row"><span class="info-label">Platform:</span><span class="info-value" id="platform"></span></div>
        <div class="info-row"><span class="info-label">Secure Context:</span><span class="info-value" id="secure"></span></div>
        <div class="info-row"><span class="info-label">Web Serial API:</span><span class="info-value" id="serial"></span></div>
      </div>
    </div>
  </div>

  <div class="log-container" id="logContainer">
    <div class="resize-handle" id="resizeHandle"></div>
    <div class="log-header" id="logHeader"><h3>📊 Console Output</h3></div>
    <div class="log-content"><pre id="log">Ready to flash...</pre></div>
  </div>

  <script>
    const browserEl = document.getElementById('browser');
    const platformEl = document.getElementById('platform');
    const serialEl = document.getElementById('serial');
    const secureEl = document.getElementById('secure');
    const logEl = document.getElementById('log');
    const bootPrompt = document.getElementById('bootPrompt');
    const logContainer = document.getElementById('logContainer');
    const resizeHandle = document.getElementById('resizeHandle');
    const logHeader = document.getElementById('logHeader');
    const mainContent = document.getElementById('mainContent');
    const buttonContainer = document.getElementById('buttonContainer');
    
    // UI ELEMENTS
    const compatibilityModeControls = document.getElementById('compatibility-mode-controls');
    const secureModeWorkflow = document.getElementById('secure-mode-workflow');
    const radioCompatibility = document.getElementById('radioCompatibility');
    const radioSecure = document.getElementById('radioSecure');

    // EXPERIMENTAL UI ELEMENTS
    const initExperimentalBtn = document.getElementById('initExperimentalBtn');
    const experimentalSecureControls = document.getElementById('experimental-secure-controls');
    const experimentalPskDisplay = document.getElementById('sessionPskDisplay');
    const experimentalDownloadSecureBtn = document.getElementById('downloadSecureBtn');
    const experimentalClearPskBtn = document.getElementById('clearPskBtn');
    const experimentalButtonContainer = document.getElementById('experimental-button-container');

    // SESSION/PERSISTENT VARIABLES
    let patchedFirmwareUrl = null;
    let uploadedFileUrl = null; // Stays for compatibility with the flash component/experimental mode
    let sessionPsk = sessionStorage.getItem('sessionPsk');
    let isResetting = false;
    
    // Display system info
    browserEl.textContent = navigator.userAgent;
    platformEl.textContent = navigator.platform;
    const hasSerial = 'serial' in navigator;
    serialEl.textContent = hasSerial ? '✅ Available' : '❌ Not Available';
    serialEl.className = hasSerial ? 'info-value status-good' : 'info-value status-bad';
    const isSecure = window.isSecureContext;
    secureEl.textContent = isSecure ? '✅ Yes' : '❌ No';
    secureEl.className = isSecure ? 'info-value status-good' : 'info-value status-bad';

    function log(msg, type = 'info') {
      const time = new Date().toLocaleTimeString();
      const prefix = type === 'error' ? '❌' : type === 'success' ? '✅' : 'ℹ️';
      logEl.textContent += `[${time}] ${prefix} ${msg}\n`;
      logEl.scrollTop = logEl.scrollHeight;
      console[type === 'error' ? 'error' : 'log'](msg);
    }

    logHeader.addEventListener('click', () => {
        logContainer.classList.toggle('minimized');
        mainContent.classList.toggle('console-open', !logContainer.classList.contains('minimized'));
    });
    mainContent.classList.add('console-open'); // Start with console open

    // Resizable console logic
    let isResizing = false;
    let startX, startY, startWidth, startHeight;
    resizeHandle.addEventListener('mousedown', (e) => { isResizing = true; startX = e.clientX; startY = e.clientY; startWidth = logContainer.offsetWidth; startHeight = logContainer.offsetHeight; e.preventDefault(); });
    document.addEventListener('mousemove', (e) => {
      if (!isResizing) return;
      if (window.innerWidth > 1024) { const width = startWidth + (e.clientX - startX); if (width >= 300 && width <= window.innerWidth * 0.6) { logContainer.style.width = width + 'px'; mainContent.style.marginLeft = width + 'px'; } }
      else { const height = startHeight - (e.clientY - startY); if (height >= 150 && height <= window.innerHeight * 0.7) { logContainer.style.height = height + 'px'; } }
    });
    document.addEventListener('mouseup', () => { isResizing = false; });

    // --- Secure Flashing Logic (now for EXPERIMENTAL mode) ---
    const PSK_LENGTH = 16;
    const PATCH_MAGIC = new Uint8Array([ 0xDE, 0xAD, 0xBE, 0xEF ]);
    const DEFAULT_PSK = new Uint8Array([
      0x7C, 0xE3, 0x91, 0x2F, 0xA8, 0x5D, 0xB4, 0x69,
      0x3E, 0xC7, 0x14, 0xF2, 0x86, 0x0B, 0xD9, 0x4A
    ]);
    const searchNeedle = new Uint8Array(PATCH_MAGIC.length + DEFAULT_PSK.length);
    searchNeedle.set(PATCH_MAGIC, 0);
    searchNeedle.set(DEFAULT_PSK, PATCH_MAGIC.length);

    function findSubarray(haystack, needle) {
      for (let i = 0; i <= haystack.length - needle.length; i++) {
        let found = true;
        for (let j = 0; j < needle.length; j++) {
          if (haystack[i + j] !== needle[j]) { found = false; break; }
        }
        if (found) return i;
      }
      return -1;
    }

    function generateHexKey(length) {
      const bytes = new Uint8Array(length);
      window.crypto.getRandomValues(bytes);
      return Array.from(bytes).map(b => b.toString(16).padStart(2, '0')).join('').toUpperCase();
    }

    async function prepareSecureFirmware() {
      // This function now targets the EXPERIMENTAL UI elements
      const flashBtn = experimentalButtonContainer.querySelector('button');
      log('Preparing Experimental Secure Firmware...');
      if(flashBtn) flashBtn.disabled = true;
      experimentalDownloadSecureBtn.disabled = true;
      experimentalPskDisplay.textContent = 'Generating key and patching firmware...';
      experimentalPskDisplay.style.color = 'var(--medium-text)';

      if (patchedFirmwareUrl) {
        URL.revokeObjectURL(patchedFirmwareUrl);
      }
      
      try {
        if (!sessionPsk) {
            sessionPsk = generateHexKey(PSK_LENGTH);
            sessionStorage.setItem('sessionPsk', sessionPsk);
            log('🔑 Generated new Secure Session PSK and saved to session storage.');
        } else {
             log('🔑 Loaded existing Secure Session PSK from session storage.');
        }

        const obfuscatedPsk = '**************************' + sessionPsk.slice(-6);
        log('****************************************************************');
        log(`🔒 Current Experimental Session PSK: ${obfuscatedPsk}`);
        log('****************************************************************');
        experimentalPskDisplay.textContent = `Session PSK: ${obfuscatedPsk}`;
        experimentalPskDisplay.style.color = 'var(--light-text)';

        // We still fetch the *original* manifest to find the *original* binary to patch
        const manifest = await (await fetch('./manifest.json?t=' + Date.now())).json();
        const firmwarePart = manifest.builds[0].parts.find(part => part.path.includes("sketch_jun11a.ino.merged.bin"));
        if (!firmwarePart) throw new Error("Could not find firmware part in manifest.");
        
        const response = await fetch(firmwarePart.path + '?t=' + Date.now());
        if (!response.ok) throw new Error(`Failed to fetch firmware: ${response.statusText}`);
        const firmwareData = new Uint8Array(await response.arrayBuffer());

        log('Searching for patchable PSK (magic + key) in firmware binary...');
        const pskOffset = findSubarray(firmwareData, searchNeedle); 

        if (pskOffset === -1) {
          throw new Error("Patchable PSK (magic+key) not found. Is the C++ sketch modified? Is it already patched?");
        }

        const patchKeyOffset = pskOffset + PATCH_MAGIC.length;
        log(`✅ Patchable target found at offset 0x${pskOffset.toString(16)}. Patching key at 0x${patchKeyOffset.toString(16)}...`);

        const pskBytes = new Uint8Array(PSK_LENGTH);
        for (let i = 0; i < PSK_LENGTH; i++) {
          pskBytes[i] = parseInt(sessionPsk.substring(i * 2, i * 2 + 2), 16);
        }
        
        firmwareData.set(pskBytes, patchKeyOffset);

        const patchedBlob = new Blob([firmwareData], { type: 'application/octet-stream' });
        
        // Create a new File object named 'upload.bin' from the patched blob
        const patchedFile = new File([patchedBlob], "upload.bin", { type: 'application/octet-stream' });
        patchedFirmwareUrl = URL.createObjectURL(patchedFile);
        log(`Patched firmware renamed in-memory to 'upload.bin' for manifest2.json`);
        
        log('✅ Experimental secure firmware is generated and ready.');
        if(flashBtn) flashBtn.disabled = false;
        experimentalDownloadSecureBtn.disabled = false;
      } catch(e) {
        log(`Error preparing experimental firmware: ${e.message}`, 'error');
        experimentalPskDisplay.textContent = "Error! Check console.";
        experimentalPskDisplay.style.color = 'var(--error-color)';
        if(flashBtn) flashBtn.disabled = true;
      }
    }

    /**
     * Creates a new esp-web-install-button component in the specified container.
     * @param {string} buttonText The text for the proxy button.
     * @param {HTMLElement} containerEl The container to append the button to.
     * @param {string} context The flash context ('compatibility', 'upload', 'experimental').
     * @param {string} [className='btn'] The CSS class for the button.
     * @returns {HTMLElement} The created esp-web-install-button element.
     */
    function createFlashButton(buttonText, containerEl, context, className = 'btn') {
      containerEl.innerHTML = '';
      
      const installButton = document.createElement('esp-web-install-button');
      installButton.patchManifest = patchManifestFn;
      installButton.addEventListener('state-changed', onStateChanged);
      installButton.addEventListener('error', onError);
      
      // Set the attribute on the *outer component* so patchManifestFn can read it
      installButton.setAttribute('data-flash-context', context);

      const buttonId = context === 'uploaded' ? 'uploadedFlashBtn' : 'flashBtn';
      
      // Inject the inner button HTML
      installButton.innerHTML = `<button slot="activate" id="${buttonId}" class="${className}" data-flash-context="${context}">${buttonText}</button>`;
      containerEl.appendChild(installButton);

      // The button's original click listener is now only used to trigger the manifest load.
      const proxyButton = installButton.querySelector('button');
      if(proxyButton) {
        proxyButton.addEventListener('click', () => {
             log(`Starting flash with context: ${context}`);
             
             // Secure mode now uses the file select built into the component
             const manifestPath = (context === 'experimental') 
                ? './manifest2.json?t=' + Date.now() 
                : './manifest.json?t=' + Date.now();
             
             log(`Loading manifest: ${manifestPath}`);
             installButton.manifest = manifestPath;

             // Only compatibility and experimental modes are active flash flows.
             installButton.removeAttribute('data-file-select');
        });
      }
      
      isResetting = false;
      return installButton;
    }


    const patchManifestFn = (manifest, target) => {
      const manifestCopy = JSON.parse(JSON.stringify(manifest));
      
      // Read the context from the `target` component, which now has the attribute
      const context = target.getAttribute('data-flash-context') || 'compatibility';
      
      
      if (context === 'experimental') {
        // We are now loading manifest2.json, which expects 'upload.bin'
        const firmwarePart = manifestCopy.builds[0].parts.find(part => part.path.includes("upload.bin"));
        
        if (!firmwarePart) {
            log('Could not find "upload.bin" in the loaded manifest (expected manifest2.json).', 'error');
            throw new Error("Firmware part 'upload.bin' not found.");
        }
        if (!patchedFirmwareUrl || !sessionPsk) {
            log('Experimental secure firmware has not been generated. Cannot flash.', 'error');
            throw new Error("Experimental secure firmware not ready.");
        }
        
        const obfuscatedPsk = '**************************' + sessionPsk.slice(-6);
        log(`Flashing in Experimental Secure Mode with session PSK: ${obfuscatedPsk}`);
        
        // Point the 'upload.bin' part to our in-memory patched blob
        firmwarePart.path = patchedFirmwareUrl;
        return manifestCopy;
      }
      
      // Default: 'compatibility'
      const firmwarePart = manifestCopy.builds[0].parts.find(part => part.path.includes("sketch_jun11a.ino.merged.bin"));
      
      if (!firmwarePart) {
          log('Could not find "sketch_jun11a.ino.merged.bin" in the loaded manifest (expected manifest.json).', 'error');
          throw new Error("Firmware part 'sketch_jun11a.ino.merged.bin' not found.");
      }
      
      log('Flashing in Compatibility Mode (using default PSK)');
      firmwarePart.path = firmwarePart.path + '?t=' + Date.now();
      return manifestCopy;
    };

    const onStateChanged = (e) => {
      const state = e.detail;
      if (isResetting) return;
      log(`State: ${state}`);
      
      const isWorking = ['PREPARING', 'UPLOADING', 'INITIALIZING'].includes(state);
      bootPrompt.classList.toggle('show', isWorking);

      const isFinished = ['FINISHED', 'ERROR', 'DASHBOARD'].includes(state);

      if (isFinished) {
        if (isResetting) return;
        isResetting = true;
        
        log('Flash flow finished. Tool is resetting...');

        if (state === 'FINISHED') {
          log('✅ Flash complete! Press RESET button on ESP32.', 'success');
          log('   Tool is resetting. Ready for the next device...');
          alert("Flash Complete! The tool has reset for the next device. If you cannot flash the next device (e.g., the browser does not show the port selection dialog), please refresh the page and try again.");
        } else if (state === 'ERROR') {
          log('❌ Flash failed. Try unplugging/replugging the device and the BOOT button procedure.', 'error');
          log('   Tool is resetting...');
        } else if (state === 'DASHBOARD') {
           log('ℹ️ Operation cancelled or closed. Resetting tool...');
        }
        
        // Find the active dialog and close it
        const dialog = document.querySelector("ewt-dialog");
        if (dialog) { dialog.close(); }
        
        setTimeout(() => {
          // Re-initialize the UI.
          initFlashMode(); 
        }, 1500);
      }
    };

    const onError = (e) => {
      if (isResetting) return;
      log(`Error: ${e.detail.message || e.detail}`, 'error');
    };

    function initFlashMode() {
        const mode = radioCompatibility.checked ? 'compatibility' : 'secure';
        
        // Reset experimental button state
        initExperimentalBtn.disabled = false;
        experimentalButtonContainer.innerHTML = ''; // Clear old experimental button
        experimentalDownloadSecureBtn.disabled = true;
        if (!sessionPsk) {
            experimentalPskDisplay.textContent = 'Session PSK will be generated automatically...';
            experimentalPskDisplay.style.color = 'var(--medium-text)';
        }

        if (mode === 'compatibility') {
            buttonContainer.style.display = 'block';
            compatibilityModeControls.style.display = 'block';
            secureModeWorkflow.style.display = 'none';

            // Create the main flasher button for compatibility mode
            createFlashButton('⚡ Flash Firmware', buttonContainer, 'compatibility');

        } else { // 'secure' mode (Download Only)
            buttonContainer.style.display = 'none';
            compatibilityModeControls.style.display = 'none';
            secureModeWorkflow.style.display = 'block';
            
            // NO FLASH BUTTON IS CREATED HERE
        }
    }
    
    // --- UI Event Listeners ---
    
    // Main radio button listener
    document.querySelectorAll('input[name="flashMode"]').forEach(radio => {
      radio.addEventListener('change', (e) => {
        log('Mode changed. Re-initializing UI...');
        initFlashMode();
      });
    });

    // --- Experimental (Advanced) Section Listeners ---

    initExperimentalBtn.addEventListener('click', () => {
        log('Initializing experimental secure flasher...');
        // Create the flasher component in the experimental container
        const installButton = createFlashButton('⚡ Flash Experimental Secure Firmware', experimentalButtonContainer, 'experimental');
        
        // Find the inner button and disable it temporarily
        const experimentalFlashBtn = installButton.querySelector('button');
        if (experimentalFlashBtn) {
           experimentalFlashBtn.disabled = true;
        }
        
        // Start the firmware patching
        prepareSecureFirmware(); // This will enable the button when ready
        
        initExperimentalBtn.disabled = true; // Only init once
    });

    experimentalDownloadSecureBtn.addEventListener('click', () => {
        if (!patchedFirmwareUrl || !sessionPsk) {
            log('Secure firmware not available for download.', 'error');
            return;
        }
        const a = document.createElement('a');
        a.href = patchedFirmwareUrl;
        // The file is already named 'upload.bin' in memory, but we can name the download
        // to be more descriptive.
        a.download = `experimental_secure_firmware_${sessionPsk.slice(-6)}.bin`;
        document.body.appendChild(a);
        a.click();
        document.body.removeChild(a);
        log(`Downloading secure firmware: ${a.download}`);
    });

    experimentalClearPskBtn.addEventListener('click', () => {
        if (!confirm('Are you sure you want to clear the current experimental session key?')) {
            return;
        }
        sessionStorage.removeItem('sessionPsk');
        sessionPsk = null; 
        
        // Also revoke the old blob URL
        if (patchedFirmwareUrl) {
            URL.revokeObjectURL(patchedFirmwareUrl);
            patchedFirmwareUrl = null; 
        }

        log('Experimental security key cleared.');
        
        // Re-run the init process if the button has already been pressed
        if (initExperimentalBtn.disabled) {
            log('Re-initializing experimental flasher with new key...');
            const installButton = experimentalButtonContainer.querySelector('esp-web-install-button');
            if (installButton) {
                const innerButton = installButton.querySelector('button');
                if (innerButton) innerButton.disabled = true;
            }
            experimentalDownloadSecureBtn.disabled = true;
            prepareSecureFirmware();
        } else {
             experimentalPskDisplay.textContent = 'Session PSK cleared.';
             experimentalPskDisplay.style.color = 'var(--medium-text)';
        }
    });


    // --- Initial Page Load ---
    (async () => {
      try {
        const cacheBust = '?t=' + Date.now();
        const manifestRes = await fetch('./manifest.json' + cacheBust);
        if (!manifestRes.ok) throw new Error(`manifest.json HTTP ${manifestRes.status}`);
        log('manifest.json found');

        // Also check for manifest2.json
        const manifest2Res = await fetch('./manifest2.json' + cacheBust);
        if (!manifest2Res.ok) throw new Error(`manifest2.json HTTP ${manifest2Res.status}`);
        log('manifest2.json found');

        const firmwareRes = await fetch('./sketch_jun11a.ino.merged.bin' + cacheBust, { method: 'HEAD' });
        if (!firmwareRes.ok) throw new Error(`sketch_jun11a.ino.merged.bin HTTP ${firmwareRes.status}`);
        log('sketch_jun11a.ino.merged.bin found');
      } catch (e) {
        log(e.message, 'error');
        log('CRITICAL ERROR: A required file (manifest.json, manifest2.json, or the .bin) is missing.', 'error');
      }
      
      // Set default checked state
      radioCompatibility.checked = true;
      // Initialize the UI based on default state
      initFlashMode();
      log('Ready to flash. Select a mode to begin.');
    })();

  </script>
</body>
</html>
